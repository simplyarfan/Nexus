// Prisma Schema for Nexus Backend
// Production-ready schema with full authentication and ticketing system

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USERS TABLE - Complete Authentication System
// ============================================
model User {
  id                          Int       @id @default(autoincrement())
  email                       String    @unique
  first_name                  String?
  last_name                   String?
  role                        String    @default("user")
  password_hash               String
  department                  String?
  job_title                   String?
  
  // Email Verification
  email_verified              Boolean   @default(false)
  verification_token          String?
  verification_token_expires  DateTime?
  
  // Password Reset
  reset_token                 String?
  reset_token_expires         DateTime?
  
  // Two-Factor Authentication
  is_2fa_enabled              Boolean   @default(false)
  two_factor_code             String?
  two_factor_code_expires     DateTime?
  
  // Security & Account Management
  is_active                   Boolean   @default(true)
  failed_login_attempts       Int       @default(0)
  account_locked_until        DateTime?
  last_login                  DateTime?
  
  // Timestamps
  created_at                  DateTime  @default(now())
  updated_at                  DateTime  @updatedAt
  
  // Relations
  created_tickets             SupportTicket[]   @relation("TicketCreator")
  ticket_comments             TicketComment[]
  sessions                    UserSession[]

  // Indexes for performance
  @@index([email])
  @@index([role])
  @@index([is_active])
  @@map("users")
}

// ============================================
// USER SESSIONS TABLE - JWT Session Management
// ============================================
model UserSession {
  id             Int       @id @default(autoincrement())
  user_id        Int
  session_token  String    @unique
  refresh_token  String    @unique
  ip_address     String?
  user_agent     String?
  expires_at     DateTime
  created_at     DateTime  @default(now())
  
  // Relations
  user           User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  // Indexes for performance
  @@index([user_id])
  @@index([session_token])
  @@index([refresh_token])
  @@index([expires_at])
  @@map("user_sessions")
}

// ============================================
// SUPPORT TICKETS TABLE
// ============================================
model SupportTicket {
  id          Int       @id @default(autoincrement())
  user_id     Int
  subject     String
  description String    @db.Text
  status      String    @default("open")
  priority    String    @default("medium")
  category    String?
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  // Relations
  user        User              @relation("TicketCreator", fields: [user_id], references: [id], onDelete: Cascade)
  comments    TicketComment[]

  // Indexes for performance
  @@index([user_id])
  @@index([status])
  @@index([priority])
  @@index([created_at])
  @@map("support_tickets")
}

// ============================================
// TICKET COMMENTS TABLE
// ============================================
model TicketComment {
  id          Int       @id @default(autoincrement())
  ticket_id   Int
  user_id     Int
  comment     String    @db.Text
  is_internal Boolean   @default(false)
  created_at  DateTime  @default(now())

  // Relations
  ticket      SupportTicket @relation(fields: [ticket_id], references: [id], onDelete: Cascade)
  user        User          @relation(fields: [user_id], references: [id], onDelete: Cascade)

  // Indexes for performance
  @@index([ticket_id])
  @@index([user_id])
  @@index([created_at])
  @@map("ticket_comments")
}
